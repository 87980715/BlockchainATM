区块链ATM

## 前端客人交易页
### 流程：
"开始交易"页 ->"输入卡号和密码"页[根据输入的bin去blockchain后台系统找到对应的银行，再去对应的银行验证卡号和密码；返回所属的银行]->"选择ATM"页[获取ATM图片，所属银行，支持的交易]->"选择交易"页->  
第一阶段：考虑查询余额  

## Blockchain后台页

### BIN信息页
#### 1. BIN创建页：
##### 属性： 
BIN: 6位长度数字［必填项］  
所属银行: ［必填项］  
##### 说明：
BIN：必须是未被注册过的，必须填写6位数字的BIN;必须填写银行  
bank数据是从bank模型里获取,创建bin需要在相应的bank的bins里纪录
#### 2.BIN修改页：
##### 说明：
要修改BIN的话，要保证不与数据库中其它已经注册的BIN冲突
修改bin要在相应的bank里修改bin替换新的bin  
修改bin所属的bank，要在bin里面将旧的bank替换掉，且将旧的bank里面对应的bin去掉，在新的bank里面添加bin
#### 3.BIN删除：
##### 说明：
确认删除后刷新BIN列表页，且数据库相应数据已经删除
#### 4. BIN列表页：
##### 属性：
BIN,所属银行，录入时间，更新操作，删除操作


### 银行信息页
#### 1. 银行卡创建页：
##### 属性：
所属银行：选择的银行必须是在BIN创建页中创建过的 ［必选项］  
卡号：16位长度，前6位根据选择的银行提供可以选择的6位BIN（如工商银行，622202，621226）,其它10位长度可以选择随机生成，或者手动输入 ［必填项］  
客人姓名：［必填项］  
银行卡密码：6位数字［必填项］  
银行卡余额
##### 说明：
卡号：必须是未被注册过的16位数字  
银行卡密码：在数据库中加盐处理
银行卡余额：可选项[会判断数据库中的值，默认为0]  
#### 2.银行卡修改页：
##### 说明：
要修改卡号的话，要保证不与数据库中其它已经注册的卡号冲突  
密码项不预填，提交前必须输入  
银行和bin不允许修改
#### 3.银行卡删除：
##### 说明：
确认删除后刷新银行卡列表页，且数据库[banks,bins,cards]相应数据已经删除
#### 4. 银行卡列表页：
##### 属性：
所属银行，卡号，客人姓名，余额，录入时间，更新操作，删除操作  
余额暂时直接在列表页显示

### ATM信息页
#### 1. ATM创建页：
##### 属性：
所属银行：选择的银行必须是在BIN创建页中创建过的 ［必选项］  
ATM ID：ATM ID在所有银行中必须唯一［必填项］  
位置： ［必填项］  
支持交易：只提供“查询余额”，“取款”，“存款”，“转账”四种交易作为选择［必填项］  
机型：［必填项］  
供应商：［必填项］  
机器图片地址：［必填项］
##### 说明：
”上传机器图片“操作的地址会覆盖当前“机器图片地址”

#### 2.ATM修改页：
##### 说明：
要修改ATM ID的话，要保证不与数据库中其它已经注册的ATM ID冲突;  
对上传的图片做限制大小的操作  
将atms和banks中对应的数据更新，若有更新图片，则应该将旧的图片删除

#### 3.ATM删除：
##### 说明：
将atms和banks中对应的数据删除，且将上传的文件删除;确认删除后刷新ATM列表页

### 交易信息页
##### 属性：
交易Id，类型，卡号，开始时间，完成时间，操作ATM，扣款银行，代理扣款ATM，收款银行，代理收款ATM，手续费，交易数额，状态   


### 登录管理



### 注册管理


### 关系设计
1.1.一个bank可以有多个bin  
1.2.一个bin只可以属于一个bank  
2.1.一个bin可以有多个card  
2.2.一个card只可以属于一个bin
l
### 待完成项：
1.设计查询余额交易与blockchain的交互  

### 思考：
设想每台代表geth节点的atm的作用已经变成客人兑现区块链帐户的钱(取款),以及客人存钱到区块链帐户中(存款)，此功能的atm不与其所属银行的直接交互。当然，一台atm可以想象成仍有一部分独立的接口与其所属的银行进行交互，此处的设计此考虑区块链的。  
1.每家银行在区块链中只有一个银行地址，每台代表geth节点的atm在区块链中有一个区块链帐户地址，每家银行注册了在区块链中交易的客人也要有对应的区块链帐户地址  
2.每家银行不需要在区块链中预存钱,钱的流动只会涉及到ATM和客人之间，同时BTM会暂时保管的功能    
3.每台atm因为有取款功能，所以要加钞，钞箱的钱会+到其区块链帐户中，其区块链的帐户余额不一定等于钞箱余额，只有在平账时才会同步为钞箱余额     
4.客人的银行卡假设已经有一个额外的系统（也可以是ATM存钱）转钱到区块链帐户中，所以中区块链中的银行卡余额只代表区块链中的部分，不代表该银行卡在其所属银行的实际余额    
5.设计假设和情景模拟：    
前提假设：  
  a.B001:机器中钞箱余额100,000,区块链帐户余额为100,000     
  b.小王:余额9,000  
  c.ATM里的钱是现实货币，与区块链中的数字货币不同，所以凡是涉及到ATM的数额加减，如存款，取款都要记账，BTM会暂时代为收款和扣款，最后ATM平账时会通过账本与对应的银行进行平账。   
  d.若ATM要进行平账：     
   i.若其区块链帐户余额－钞箱余额>0,则BTM要支付B行相应的钱，然后B001区块链帐户余额同步为钞箱余额；   
   ii.若区块链帐户余额－钞箱余额<=0,则B行要支付BTM相应的钱，然后B001区块链帐户余额同步为钞箱余额； 
  e.若ATM进行加钞，则区块链帐户余额要+钞箱余额   

情景1:假设A行的客人(小王)在B行的ATM(编号B001)上取款500元：  
发生的确认和交易:  
 a.确保小王在区块链的帐户有500元，且ATM钞箱余额>500元若无则应该拒绝交易；  
 b.若有>500元余额，则B001代支出500,钞箱余额99,500，区块链帐户余额100,000  
   小王收到500,这个钱是兑现的钱，所以帐户的余额为9,500  
   记账：B001区块链帐户余额-钞箱余额=500,[欠款人:BTM,待收款人：B行]  
情景2:（续情景1）假设A行的客人(小王)在B行的ATM(编号B001)上存款500元：  
发生的确认和交易:  
 a.B001代收入500,钞箱余额100,500 (99,500+500)，区块链帐户余额100,000     
   小王帐户的余额为10,000 (9,500+500)  
   记账：B001区块链帐户余额-钞箱余额=-500,[欠款人:B行,待收款人:BTM]  
### 区块链部分实现
#### 任务 1:
1.1 生成合约地址 -done   
1.2 节点地址 -done   
1.3 了解节点的增加和删除  -done  
1.4 设计geth与前后端交互界面，逻辑，路由表[暂定只支持“汇丰银行”，“工商银行”，“交通银行” 这三个银行，每家银行只有一个ATM运行在blockchain中，节点地址和智能合约地址存储在数据库中。]    

#### 任务 2:
在blockchain后台注册生成合约调用时需要的以太坊帐户地址，http地址，银行地址，并保存在数据库中，再由前台在选取atm时去获取  
contractInitVars: {    
  contractfile: "BTM",  
  web3http: "http://localhost:7101",  
  atmAdd: "0xca843569e3427144cead5e4d5999a3d0ccf92b8e",  
  ownerBank: "0x01751f1b5a22aaee0824d68b888f2190a663d768",  
  contractAdd: "0x8182dd293942ff6839e6e8c8a71981bb8ad655e5"  
}

